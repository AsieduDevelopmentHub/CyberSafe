<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>CyberSafe — Firestore Seeder</title>
  <style>body{font-family:system-ui,Segoe UI,Roboto,Arial;padding:20px;}button{padding:10px 16px;margin:6px;border-radius:6px}</style>
</head>
<body>
  <h1>CyberSafe Firestore Seeder</h1>
  <p>This page will write sample seed data to Firestore using the client SDK and the Firebase configuration in <code>dist/scripts/firebase-config.js</code>.</p>
  <p>Important: Ensure you know which project `firebase-config.js` is pointing to. Prefer using the Firebase Emulator for local testing.</p>

  <button id="seedBtn">Seed Firestore</button>
  <button id="clearBtn">Clear Seeded Docs (dangerous)</button>
  <pre id="log" style="max-height:300px;overflow:auto;background:#f6f8fa;padding:10px;border-radius:6px"></pre>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script src="../dist/scripts/firebase-config.js"></script>

<script>
(function(){
  const logEl = document.getElementById('log');
  function log(...args){
    console.log(...args);
    logEl.textContent += args.map(a => (typeof a === 'object'? JSON.stringify(a,null,2): String(a))).join(' ') + '\n';
  }

  // Seed data (keeps in sync with JSON files in seed/)
  const modules = [
    {
      id: 'phishing',
      title: 'Phishing Awareness',
      description: 'Learn to identify and avoid email scams and phishing attempts',
      icon: 'fas fa-fish',
      color: '#00B8D9',
      duration: '30 min',
      lessonsCount: 3
    },
    {
      id: 'passwords',
      title: 'Password Security',
      description: 'Create strong passwords and manage them securely',
      icon: 'fas fa-key',
      color: '#FF6F00',
      duration: '25 min',
      lessonsCount: 2
    },
    {
      id: 'social',
      title: 'Social Engineering',
      description: 'Recognize and defend against manipulation tactics',
      icon: 'fas fa-users',
      color: '#10B981',
      duration: '35 min',
      lessonsCount: 2
    }
  ];

  const lessons = {
    phishing: [
      { id: 'phishing-1', title: 'What is Phishing?', contentHtml: '<p>Phishing is a social engineering attack...</p>', videoId: 'Y7zNlEMDmI4', duration: 180, order: 1 },
      { id: 'phishing-2', title: 'Spotting Phishing Emails', contentHtml: '<p>Learn how to inspect headers...</p>', videoId: 'R12_y2BhKbE', duration: 390, order: 2 },
      { id: 'phishing-3', title: 'Responding to Phishing Attempts', contentHtml: '<p>Steps to report and remediate...</p>', videoId: 'XBkzBrXlle0', duration: 408, order: 3 }
    ],
    passwords: [
      { id: 'passwords-1', title: 'Creating Strong Passwords', contentHtml: '<p>Techniques for building strong...</p>', videoId: 'Pm9D-h7FqV4', duration: 270, order: 1 },
      { id: 'passwords-2', title: 'Using Password Managers', contentHtml: '<p>How to choose and use a password manager...</p>', videoId: 'zuvUj7GaZU8', duration: 559, order: 2 }
    ],
    social: [
      { id: 'social-1', title: 'Social Engineering Techniques', contentHtml: '<p>Common manipulation tactics...</p>', videoId: 'v7VTJhkJUUY', duration: 416, order: 1 },
      { id: 'social-2', title: 'Defending Against Social Engineering', contentHtml: '<p>Practical steps to verify requests...</p>', videoId: 'XEtvwzN_xJk', duration: 136, order: 2 }
    ]
  };

  const quizzes = [
    { id: 'phishing_quiz', moduleId: 'phishing', title: 'Phishing Basics Quiz', passingScore: 70, questions: [ { question: 'Which is a common sign of phishing?', options: ['Generic greeting','Known sender','Correct grammar','Secure domain'], correctIndex: 0 }, { question: 'What should you do with a suspicious email link?', options: ['Click to verify','Hover to inspect URL','Reply asking for details','Forward to all contacts'], correctIndex: 1 } ] },
    { id: 'passwords_quiz', moduleId: 'passwords', title: 'Password Security Quiz', passingScore: 70, questions: [ { question: "What's better for password security?", options: ['Reuse a long password','Use unique passwords and a manager','Short memorable passwords','Store passwords in email'], correctIndex: 1 }, { question: 'Multifactor authentication helps because:', options: ['It replaces passwords','It adds an extra barrier','It stores passwords securely','It hides your IP'], correctIndex: 1 } ] }
  ];

  const badges = [
    { id: 'quick_learner', name: 'Quick Learner', description: 'Complete a module in one sitting', icon: 'fas fa-bolt', criteria: { type: 'module_completion_in_one_sitting', windowMins: 60 } },
    { id: 'phishing_expert', name: 'Phishing Expert', description: 'Score 100% on Phishing Awareness quiz', icon: 'fas fa-fish', criteria: { type: 'quiz_score', moduleId: 'phishing', minScore: 100 } }
  ];

  const users = [
    { uid: 'sampleUser1', name: 'Test User', email: 'tester@example.com', photoURL: 'https://ui-avatars.com/api/?name=Test+User', progress: { overall: 0, completedModules: [], currentStreak: 0, lastActivity: null, totalPoints: 0, level: 1 } }
  ];

  const seedBtn = document.getElementById('seedBtn');
  const clearBtn = document.getElementById('clearBtn');

  async function seed() {
    log('Starting seed...');
    const db = firebase.firestore();

    // Ensure we are authenticated before attempting writes. The Firestore rules
    // in this project require authenticated requests for many paths. We sign in
    // anonymously here so the client can perform writes allowed for authenticated
    // users (recommended to use the Emulator for safety).
    if (!firebase.auth().currentUser) {
      try {
        log('No authenticated user found — signing in anonymously...');
        await firebase.auth().signInAnonymously();
        log('Signed in anonymously as', firebase.auth().currentUser && firebase.auth().currentUser.uid);
      } catch (err) {
        log('Auth error:', err.message || err);
        throw err;
      }
    }

    try {
      // Write modules
      for (const m of modules) {
        await db.collection('modules').doc(m.id).set({
          title: m.title,
          description: m.description,
          icon: m.icon,
          color: m.color,
          duration: m.duration,
          lessonsCount: m.lessonsCount,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        log('Wrote module', m.id);

        // Write lessons subcollection
        const moduleLessons = lessons[m.id] || [];
        for (const L of moduleLessons) {
          await db.collection('modules').doc(m.id).collection('lessons').doc(L.id).set({
            title: L.title,
            contentHtml: L.contentHtml,
            videoId: L.videoId,
            duration: L.duration,
            order: L.order,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          log('  Wrote lesson', L.id);
        }
      }

      // Write quizzes
      for (const q of quizzes) {
        await db.collection('quizzes').doc(q.id).set({
          moduleId: q.moduleId,
          title: q.title,
          passingScore: q.passingScore,
          questions: q.questions,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        log('Wrote quiz', q.id);
      }

      // Write badges
      for (const b of badges) {
        await db.collection('badges').doc(b.id).set({
          name: b.name,
          description: b.description,
          icon: b.icon,
          criteria: b.criteria,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        log('Wrote badge', b.id);
      }

      // NOTE: Writing `users/{uid}` documents from the client is restricted by
      // your Firestore rules (they generally require request.auth.uid == uid).
      // The Admin SDK is the safest way to create arbitrary user documents with
      // a chosen uid. To avoid permission errors from the client seeder, we do
      // NOT write sample `users` documents here. If you want to seed users via
      // the client, run an authenticated flow where the current user's uid
      // matches the document id, or use the Admin seeder (recommended).
      log('Skipping client-side user document writes. Use Admin seeder for users.');

      log('Seed complete ✅');
    } catch (err) {
      log('Seed error:', err.message || err);
      console.error(err);
    }
  }

  async function clearSeed() {
    if (!confirm('This will DELETE the seeded collections (modules, quizzes, badges, users). Are you sure?')) return;
    const db = firebase.firestore();
    try {
      for (const m of modules) {
        // delete lessons first
        const lessonsSnap = await db.collection('modules').doc(m.id).collection('lessons').get();
        for (const doc of lessonsSnap.docs) await doc.ref.delete();
        await db.collection('modules').doc(m.id).delete();
        log('Deleted module', m.id);
      }
      for (const q of quizzes) { await db.collection('quizzes').doc(q.id).delete(); log('Deleted quiz', q.id); }
      for (const b of badges) { await db.collection('badges').doc(b.id).delete(); log('Deleted badge', b.id); }
      for (const u of users) { await db.collection('users').doc(u.uid).delete(); log('Deleted user', u.uid); }
      log('Clear complete ✅');
    } catch (err) { log('Clear error:', err.message || err); console.error(err); }
  }

  seedBtn.addEventListener('click', seed);
  clearBtn.addEventListener('click', clearSeed);

})();
</script>
</body>
</html>
